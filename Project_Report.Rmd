---
title: |
  ETC5543 Business Analytics Creative Activity 
  
  Project Report
date:  "`r format(Sys.time(), '%d %B, %Y')`"
author:
  - Xianghe XU 
  
team: Group 1
subtitle: |
  Department of Econometrics and Business Statistics

  Monash University
  
  | - 
  
  __An investigation report on performance of probability-based panels compared to other methods.__
  
  | -
abstract: "The aim of this report..."
header-includes: 
  - \renewcommand{\and}{\\ \\}
  - \AddToHook{env/abstract/before}{\vspace*{2cm}}
  - \makeatletter\AddToHook{cmd/@date/before}{\vspace*{2cm}}\makeatother
output:
  bookdown::pdf_document2:
    toc: FALSE
    number_sections: TRUE
  html_document: default
   


---
\newpage

\newpage
\tableofcontents
\newpage

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  message = FALSE,  
  warning = FALSE,  
  error = FALSE,    
  out.width = "70%",
  fig.align = "center",
  fig.width = 8, 
  fig.height = 7,
  fig.retina = 3,
  fig.pos = "H", 
  out.extra = "")
```

```{r}
# Load packages and data
library(tidyverse)
library(haven)
library(shiny)
library(kableExtra)
library(gridExtra)

dat <- haven::read_sav("../Data and survey materials/ACSSM Final Data_27-Feb-2023 weighted.sav")
```

```{r}
dat1 <- dat %>% 
  mutate(prob_based = ifelse(DataSource <= 5, "Probablity based", "Non-probablity based")) %>% # Indicate probability based
  filter(DataSource %in% c(2, 5, 6, 7, 8, 9)) # Filter data source

```


```{r}
# Mutate new column with DataSource name
dat1 <- dat1 %>% 
  mutate(DataSource_name = case_when(
    DataSource == 2 ~ "Life in Australia",
    DataSource == 5 ~ "SMS push to web",
    DataSource == 6 ~ "Panel 1",
    DataSource == 7 ~ "Panel 2",
    DataSource == 8 ~ "Panel 3",
    DataSource == 9 ~ "Panel 4")) %>% 
  mutate(DataSource_name = factor(DataSource_name,
                       levels = c("Life in Australia",
                                  "SMS push to web",
                                  "Panel 1",
                                  "Panel 2",
                                  "Panel 3",
                                  "Panel 4"),
                       labels = c("Life in Australia",
                                  "SMS push to web",
                                  "Panel 1",
                                  "Panel 2",
                                  "Panel 3",
                                  "Panel 4"))) # Use str() to check levels
```

# Distribution of page time

```{r}
# distribution of page time for section 2, 4-9
dat1 %>% 
  # filter(Section_SUM_main < 120) %>% 
  ggplot(aes(x = DataSource_name,
                   y = Section_SUM_main,
                   color = prob_based)) +
  geom_point() + 
  geom_boxplot() + 
  geom_hline(yintercept = 70 * 2 / 60, color = "purple", size = 1) +
  geom_text(aes(2,70 * 2 / 60, label = "`Cutoff` Time: 2.33 mins", vjust = 2), show.legend = FALSE, color = "purple") +
  scale_color_brewer(palette = "Set1") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, hjust=1)) +
  labs(x = "",
       y = "Total time for sections in minutes",
       color = "",
       title = "Distributions of time answering the survey questions for panels ")

dat1 %>% 
  filter(Section_SUM_main < 120) %>% 
  ggplot(aes(x = DataSource_name,
                   y = Section_SUM_main,
                   color = prob_based)) +
  geom_point() + 
  geom_boxplot() + 
  geom_hline(yintercept = 70 * 2 / 60, color = "purple", size = 1) +
  geom_text(aes(2,70 * 2 / 60, label = "`Cutoff` Time: 2.33 mins", vjust = 2), show.legend = FALSE, color = "purple") +
  scale_color_brewer(palette = "Set1") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, hjust=1)) +
  labs(x = "",
       y = "Total time for sections in minutes",
       color = "",
       title = "Distributions of time answering the survey questions for panels ")

dat1 %>% 
  filter(Section_SUM_main < 20) %>% 
  ggplot(aes(x = DataSource_name,
                   y = Section_SUM_main,
                   color = prob_based)) +
  geom_point() + 
  geom_boxplot() + 
  geom_hline(yintercept = 70 * 2 / 60, color = "purple", size = 1) +
  geom_text(aes(2,70 * 2 / 60, label = "`Cutoff` Time: 2.33 mins", vjust = 2), show.legend = FALSE, color = "purple") +
  scale_color_brewer(palette = "Set1") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, hjust=1)) +
  labs(x = "",
       y = "Total time for sections in minutes",
       color = "",
       title = "Distributions of time answering the survey questions for panels ")

dat1 %>% 
  filter(Section_SUM_main < 4) %>% 
  ggplot(aes(x = DataSource_name,
                   y = Section_SUM_main,
                   color = prob_based)) +
  geom_point() + 
  geom_boxplot() + 
  geom_hline(yintercept = 70 * 2 / 60, color = "purple", size = 1) +
  geom_text(aes(2,70 * 2 / 60, label = "`Cutoff` Time: 2.33 mins", vjust = 2), show.legend = FALSE, color = "purple") +
  scale_color_brewer(palette = "Set1") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, hjust=1)) +
  labs(x = "",
       y = "Total time for sections in minutes",
       color = "",
       title = "Distributions of time answering the survey questions for panels ")

```

# Page time frequency

```{r}
# page time
dat1 %>% select(DataSource_name,
               Section_Length_4:Section_Length_9,
               -Section_Length_8,
               prob_based) %>% 
  rowwise() %>% 
  mutate("ave" = sum(c(Section_Length_4,
                       Section_Length_5,
                       Section_Length_6,
                       Section_Length_7,
                       Section_Length_9), na.rm = TRUE) *60 /64) %>% 
  filter(ave > 0,
         ave < 2) %>% 
  group_by(prob_based, DataSource_name) %>% 
  summarise(count = n()) %>% 
  # mutate(DataSource = as.factor(DataSource)) %>% 
  # mutate(prob_based = c(rep("Probability based", 3),
  #                       rep("Non-Probability based",4))) %>% 
  ggplot(aes(x = DataSource_name,
             y = count,
             fill = prob_based)) + 
  geom_col() + 
  theme_bw() +
  labs(x = "",
       y = "Number of observations",
       fill = "",
       title = "Distribution of observations under 2 seconds per question") +
  geom_text(size = 3, aes(label = round(count, 0)), vjust = -0.5, check_overlap = TRUE, position = position_dodge(width = 0.9)) +
  theme(axis.text.x = element_text(angle=15, hjust=1))
```
# Item non-response

```{r}
# Percentage of item non-response
Item_non_response <- dat1 %>% 
  select(c(DataSource_name,
           prob_based,
           GENDER:SUBURB,
           IMPPROB:INCOME,
           -IMPPROB_VERB,
           -GENDER_oth,
           -SUBURB,
           -VOTE_PARTY_oth,
           -HOMEOWNER_oth,
           -PANELREASON_oth,
           -HIGHEST_QUALIFICATION_oth,
           -COB_oth,
           -POSTCODE,
           -VOTE,
           -VOTE_PARTY,
           -EDU_CHECK,
           -HIGHEST_SCHOOLING,
           -FURTHER_EDU,
           -HIGHEST_QUALIFICATION,
           -VALI_LOCATION,
           -VALI_LOCATION_oth,
           -VALI_OVERHEAR,
           -VALI_FURTHER)) %>%
  as.data.frame() %>% 
  pivot_longer(GENDER:INCOME,
               names_to = "Question",
               values_to = "Answer") %>% 
  mutate(Answer = as.numeric(Answer)) %>% 
  mutate(Non_response = ifelse(Answer %in% c(-98, -99), 1, 0)) %>% 
  select(DataSource_name, prob_based, Non_response) %>% 
  group_by(prob_based, DataSource_name) %>% 
  summarise(Percentage = sum(Non_response) / n() * 100) 

Item_non_response %>% 
  ggplot(aes(x = DataSource_name,
             y = Percentage,
             fill = prob_based)) +
  geom_col() +
  theme_bw() +
  labs(fill = "",
       x = "Panels") +
  theme(axis.text.x = element_text(angle=15, hjust=1)) +
  geom_text(size = 3, aes(label = round(Percentage, 2)), vjust = -0.5, check_overlap = TRUE, position = position_dodge(width = 0.9)) 


```

# Item non-response for health condition

```{r}
# Item non-response for variables HEALTHCON i.e. HEALTHCON_98 HEALTHCON_99
dat1 %>% select(DataSource_name,
                prob_based,
                HEALTHCON_98,
                HEALTHCON_99) %>%
  pivot_longer(HEALTHCON_98:HEALTHCON_99,
               names_to = "Question",
               values_to = "Answer") %>%
  select(DataSource_name, prob_based, Answer) %>%
  group_by(prob_based, DataSource_name) %>%
  summarise(Percentage = sum(Answer) / n() * 100) %>%
  ggplot(aes(x = DataSource_name,
             y = Percentage,
             fill = prob_based)) +
  geom_col() +
  theme_bw() +
  labs(fill = "",
       x = "Panels") +
  theme(axis.text.x = element_text(angle=15, hjust=1)) +
  geom_text(size = 3, aes(label = round(Percentage, 2)), vjust = -0.5, check_overlap = TRUE, position = position_dodge(width = 0.9))
  # geom_col(fill = "#069AF3")
  
```

# Straight lining, use variables: K6, TV_TIME, INTERNET, BENTYPE

```{r}
# Straight lining, use variables: K6, TV_TIME, INTERNET, BENTYPE
# NOTE: 9 observations (`DataSource`: 2/6/6/6/7/7/7/8/9) select all `YES` in BENTYPE, only one obs reflects on straight-lining
straight_lining <- dat1 %>% 
  select(DataSource_name,
         starts_with("K6_"),
         starts_with("TV_TIME_"),
         starts_with("INTERNET"),
         starts_with("BENTYPE_")) %>% 
  rowwise() %>% 
  mutate(K6_IER = ifelse(length(unique(c(K6_a,
                                         K6_b,
                                         K6_c,
                                         K6_d,
                                         K6_e,
                                         K6_f))) == 1, 1, 0)) %>% 
  mutate(TV_TIME_IER = ifelse(length(unique(c(TV_TIME_a,
                                              TV_TIME_b,
                                              TV_TIME_c,
                                              TV_TIME_d,
                                              TV_TIME_e,
                                              TV_TIME_f))) == 1, 1, 0)) %>% 
  mutate(INTERNET_IER = ifelse(length(unique(c(INTERNET_a,
                                              INTERNET_b,
                                              INTERNET_c,
                                              INTERNET_d))) == 1, 1, 0)) %>% 
  mutate(BENTYPE_IER = ifelse(sum((c(BENTYPE_a, # All `YES` for 5 BENTYPE => IER
                                         BENTYPE_b,
                                         BENTYPE_c,
                                         BENTYPE_d,
                                         BENTYPE_e
                                         ))) == 5, 1, 0)) %>% 
  mutate(straight_lining = ifelse(sum(K6_IER, 
                                      TV_TIME_IER,
                                      INTERNET_IER,
                                      BENTYPE_IER) >= 2, 1, 0)) 

straight_lining %>% 
  select(DataSource_name, straight_lining) %>% 
  table() %>% 
  kable(caption = "1 = Straight lining") %>% 
  kable_classic()
```

# mid-point selection: 

Ordinal answers, odd # of answer option

__K6 questions__

- All the time to none of the time 

```{r}
# mid-point selection (frequency count)
dat1 %>% 
  select(DataSource_name,
         prob_based,
         starts_with("K6_")) %>% 
  pivot_longer(K6_a:K6_f,
               names_to = "K6_name",
               values_to = "K6_value") %>% 
  mutate(K6_value = as.numeric(K6_value)) %>% 
  filter(K6_value == 3) %>% 
  group_by(prob_based, DataSource_name, K6_name) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = DataSource_name,
             y = count,
             fill = K6_name)) +
  geom_col(position = "stack") + 
  scale_fill_brewer(palette = "Set3") +
  theme_bw()
```

# mid-point selection (%)

```{r}
# mid-point selection (Percentage)
mps1 <- dat1 %>% 
  select(DataSource_name,
         prob_based,
         starts_with("K6_")) %>% 
  pivot_longer(K6_a:K6_f,
               names_to = "K6_name",
               values_to = "K6_value") %>% 
  mutate(K6_value = as.numeric(K6_value)) %>% 
  mutate(K6_IER = ifelse(K6_value == 3, 1, 0)) %>% 
  group_by(prob_based, DataSource_name, K6_name) %>% 
  summarise(Percentage = sum(K6_IER) / n() * 100) %>% 
  ggplot(aes(x = DataSource_name,
             y = Percentage,
             group = K6_name,
             color = K6_name)) +
  geom_point() +
  geom_line() + 
  scale_fill_brewer(palette = "Set2") +
  theme_bw() +
  theme(legend.position = "bottom")

# With K6
mps2 <- dat1 %>% 
  select(DataSource_name,
         prob_based,
         starts_with("K6_")) %>% 
  pivot_longer(K6_a:K6_f,
               names_to = "K6_name",
               values_to = "K6_value") %>% 
  mutate(K6_value = as.numeric(K6_value)) %>% 
  mutate(K6_IER = ifelse(K6_value == 3, 1, 0)) %>% 
  group_by(prob_based, DataSource_name) %>% 
  summarise(Percentage = sum(K6_IER) / n() * 100) %>% 
  ggplot(aes(x = DataSource_name,
             y = Percentage,
             fill = prob_based)) +
  geom_col() +
  scale_fill_brewer(palette = "Set1") +
  theme_bw() +
  labs(fill = "") +
  geom_text(size = 3, aes(label = round(Percentage, 0)), vjust = -0.5, check_overlap = TRUE, position = position_dodge(width = 0.9)) +
  theme(legend.position = "bottom")

grid.arrange(mps1, mps2, nrow = 1)
```

# mid-point selection for: `MULTICULT`, `HELP`, `GENTRUST`

```{r}
# MULTICULT, HELP, GENTRUST
dat1 %>% 
  select(DataSource_name,
         prob_based,
         MULTICULT,
         HELP,
         GENTRUST) %>% 
  pivot_longer(MULTICULT:GENTRUST,
               names_to = "K6_name",
               values_to = "K6_value") %>% 
  mutate(K6_value = as.numeric(K6_value)) %>% 
  mutate(K6_IER = ifelse(K6_value == 3, 1, 0)) %>% 
  group_by(prob_based, DataSource_name) %>% 
  summarise(Percentage = sum(K6_IER) / n() * 100) %>% 
  ggplot(aes(x = DataSource_name,
             y = Percentage,
             fill = prob_based)) +
  geom_col() +
  scale_fill_brewer(palette = "Set1") +
  theme_bw() +
  labs(fill = "") +
  geom_text(size = 3, aes(label = round(Percentage, 0)), vjust = -0.5, check_overlap = TRUE, position = position_dodge(width = 0.9)) 

```

# Consistency

```{r}
# Consistency
dat1 %>% 
  select(DataSource_name,
         prob_based,
         starts_with("BENTYPE")) %>% 
  rowwise() %>% 
  mutate(K6_IER = ifelse(sum((c(BENTYPE_a,
                                         BENTYPE_b,
                                         BENTYPE_c,
                                         BENTYPE_d,
                                         BENTYPE_e
                                         ))) == 5, 1, 0)) %>% 
  filter(K6_IER == 1) %>% 
  kable(caption = "`YES` for all benefits") %>% 
  kable_classic_2()

# Consistency: BENTYPE_d (Carer Allowance) == `YES` & UNPAIDCARE == `NO` => Not read the question carefully
BENTYPE_UNPAIDCARE <- dat1 %>% 
  select(DataSource_name,
         prob_based,
         BENTYPE_d,
         UNPAIDCARE) %>% 
  rowwise() %>% 
  mutate(BENTYPE_UNPAID_IER = ifelse((BENTYPE_d == 1) & (UNPAIDCARE == 2), 1, 0)) 
# %>% 
#   filter(BENTYPE_UNPAID_IER == 1)


BENTYPE_UNPAIDCARE %>% 
  group_by(prob_based, DataSource_name) %>% 
  summarise(Percentage = sum(BENTYPE_UNPAID_IER) / n() * 100) %>% 
  ggplot(aes(x = DataSource_name,
             y = Percentage,
             fill = prob_based)) +
  geom_col() +
  scale_fill_brewer(palette = "Set1") +
  theme_bw() +
  labs(fill = "") +
  geom_text(size = 3, aes(label = round(Percentage, 2)), vjust = -0.5, check_overlap = TRUE, position = position_dodge(width = 0.9))

# Correlation AGE AND FIRST DRINK
dat1 %>% 
  select(DataSource_name,
         prob_based,
         AGE,
         FIRSTDRINK) %>% 
  filter(AGE >= 0,
         FIRSTDRINK >= 0) %>% 
  ggplot(aes(x = AGE,
             y= FIRSTDRINK)) + 
  geom_point() +
  geom_point(data = dat1 %>% select(DataSource_name,
                                   AGE,
                                   FIRSTDRINK) %>%
              filter(AGE >= 0,
                     FIRSTDRINK >= 0,
                     FIRSTDRINK > AGE), color = "red", size = 5) +
  geom_abline(slope = 1, color = "red") + 
  theme_bw() +
  geom_text(data = dat1 %>% select(DataSource_name,
                                   prob_based,
                                   AGE,
                                   FIRSTDRINK) %>%
              filter(AGE >= 0,
                     FIRSTDRINK >= 0,
                     FIRSTDRINK > AGE), 
            size = 5,
            color = "red",
            aes(label = paste0(DataSource_name, "\n", "(", prob_based, ")")),
            vjust = -0.5,
            hjust = 0,
            check_overlap = TRUE,
            position = position_dodge(width = 0.9))
```


```{r}
# dat %>% select(starts_with("TV_TIME")) %>% filter(TV_TIME_c == 6) %>% mutate("TOTAL" = TV_TIME_a+ TV_TIME_b+TV_TIME_c+ TV_TIME_d+ TV_TIME_e+ TV_TIME_f) %>% arrange(-TOTAL)

# Example code of mahalanobis 

# dat <- data.frame(ar = rnorm(200,1,2),
#                   be = rbinom(200,3,0.2),
#                   wo = runif(200))
# head(dat)
# S <- var(dat)
# mu <- colMeans(dat)
# D2 <- mahalanobis(dat,
#                   center = mu,
#                   cov = S)
```



# Introduction and Motivation
(include the readings)

# Survey quality metrics

# Data Description

# Chanllenges
- Understand the metrics
- matching the metrics to variables

# Preliminary Analysis

# Analysis

# Limitation

# Summary

\newpage

# Reference

__Citation of R package__

Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL,
  Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019).
  “Welcome to the tidyverse.” _Journal of Open Source Software_, *4*(43), 1686. doi:10.21105/joss.01686
  <https://doi.org/10.21105/joss.01686>.
  
Xie Y (2023). _bookdown: Authoring Books and Technical Documents with R Markdown_. R
  package version 0.35, <https://github.com/rstudio/bookdown>.
  
\newpage

# Appendix: All code for this report

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
